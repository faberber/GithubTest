global class testBatch implements Database.Batchable<sObject>, Database.Stateful, Database.AllowsCallouts {
    
    
    global Database.QueryLocator start(Database.BatchableContext BC){
        return Database.getQueryLocator([Select Id From Quote]);
    }
    
    global void execute(Database.BatchableContext BC, List<sObject> scope){
        system.debug('test');
    }
    
    global void finish(Database.BatchableContext BC){
        List<CVInformation__c> csInfos=[SELECT Id, OwnerId, IsDeleted, Name, CurrencyIsoCode, RecordTypeId, 
                                        LastModifiedById,  School_Name__c, School_Type__c, City__c, Graduated_Status__c,
                                        Grade_Average__c, CV__c, Last_Worked_Company__c, Department__c, 
                                        Position_in_The_Last_Company__c, Certificate_Name__c, Level__c, Institution__c, 
                                        Years__c FROM CVInformation__c
                                       ];
        
         PageReference excelPage = Page.oppexcel;
        excelPage.getParameters().put('selectedCurrencyISOCode','0061j000006x8QwAAI');
        
        Http http = new Http();
        HttpRequest req = new HttpRequest();
        req.setEndpoint(Url.getOrgDomainUrl().toExternalForm() + excelPage.getUrl());
        req.setMethod('POST');
        req.setHeader('Authorization', 'Bearer '+UserInfo.getSessionId());


// Rather than including the data in the GET header we put it into a POST request body.
//req.setBody('oppSerialize='+JSON.serialize(csInfos));
req.setBody('oppSerialize={oppSerialize=[{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Amount\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":11212.20,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008xmrnIAA"},"Id":"005D0000008xmrnIAA","Name":"Elena Lunghi"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSIUAA2"},"Id":"00120000002mSIUAA2","Name":"Nestle (Spain)","Country__c":"Spain","Report_Region__c":"EMEA"},"Amount":6000.00,"CurrencyIsoCode":"GBP","Report_Month__c":"2022-05-01","Product_Family__c":"Food and Drink (EMEA)","Type":"Renewal","Name":"Nestle - Spain - MFD - Renewal - 2022","OwnerId":"005D0000008xmrnIAA","AccountId":"00120000002mSIUAA2","StageName":"Fallback - Opportunity","Id":"0063z000017gDe0AAE"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Amount\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":44848.80,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D00000051tzbIAA"},"Id":"005D00000051tzbIAA","Name":"France Lasnier"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002m9L2AAI"},"Id":"00120000002m9L2AAI","Name":"Nestlé Switzerland","Country__c":"Switzerland","Report_Region__c":"EMEA"},"Amount":24000.00,"CurrencyIsoCode":"GBP","Report_Month__c":"2022-05-01","Product_Family__c":"Food and Drink (EMEA)","Type":"Renewal","Name":"Purina - Switzerland - MFD - Renewal - 2022","OwnerId":"005D00000051tzbIAA","AccountId":"00120000002m9L2AAI","StageName":"Closed - Fallback","Id":"0063z000017gDdVAAU"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Amount\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":16926.63,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008sDNOIA2"},"Id":"005D0000008sDNOIA2","Name":"Aline Meloni"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSHNAA2"},"Id":"00120000002mSHNAA2","Name":"Nestle (Brazil)","Country__c":"Brazil","Report_Region__c":"LAR"},"Amount":12000.00,"CurrencyIsoCode":"USD","Report_Month__c":"2022-04-30","Product_Family__c":"Mintel Reports (LAR)","Type":"Upgrade","Name":"Nestle - Trends, BR Reports Food & Lifestyle","OwnerId":"005D0000008sDNOIA2","AccountId":"00120000002mSHNAA2","StageName":"Closed - Fallback","Id":"0063z000011orDMAAY"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":0,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008sDNOIA2"},"Id":"005D0000008sDNOIA2","Name":"Aline Meloni"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSHQAA2"},"Id":"00120000002mSHQAA2","Name":"Nestle (Chile)","Country__c":"Chile","Report_Region__c":"LAR"},"CurrencyIsoCode":"USD","Report_Month__c":"2022-04-30","Product_Family__c":"Mintel Reports (LAR)","Type":"Upgrade","Name":"Nestlé Chile - Global Consumer tool","OwnerId":"005D0000008sDNOIA2","AccountId":"00120000002mSHQAA2","StageName":"Closed - Fallback","Id":"0063z000015YfiLAAS"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":0,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008sDNOIA2"},"Id":"005D0000008sDNOIA2","Name":"Aline Meloni"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSHuAAM"},"Id":"00120000002mSHuAAM","Name":"Nestle (Mexico)","Country__c":"Mexico","Report_Region__c":"LAR"},"CurrencyIsoCode":"USD","Report_Month__c":"2022-04-30","Product_Family__c":"Mintel Reports (LAR)","Type":"Upgrade","Name":"Nestlé Mexico - Global Consumer tool","OwnerId":"005D0000008sDNOIA2","AccountId":"00120000002mSHuAAM","StageName":"Closed - Fallback","Id":"0063z000015YmGOAA0"}],oppSerialize2=[{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Amount\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":11212.20,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008xmrnIAA"},"Id":"005D0000008xmrnIAA","Name":"Elena Lunghi"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSIUAA2"},"Id":"00120000002mSIUAA2","Name":"Nestle (Spain)","Country__c":"Spain","Report_Region__c":"EMEA"},"Amount":6000.00,"CurrencyIsoCode":"GBP","Report_Month__c":"2022-05-01","Product_Family__c":"Food and Drink (EMEA)","Type":"Renewal","Name":"Nestle - Spain - MFD - Renewal - 2022","OwnerId":"005D0000008xmrnIAA","AccountId":"00120000002mSIUAA2","StageName":"Fallback - Opportunity","Id":"0063z000017gDe0AAE"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Amount\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":44848.80,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D00000051tzbIAA"},"Id":"005D00000051tzbIAA","Name":"France Lasnier"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002m9L2AAI"},"Id":"00120000002m9L2AAI","Name":"Nestlé Switzerland","Country__c":"Switzerland","Report_Region__c":"EMEA"},"Amount":24000.00,"CurrencyIsoCode":"GBP","Report_Month__c":"2022-05-01","Product_Family__c":"Food and Drink (EMEA)","Type":"Renewal","Name":"Purina - Switzerland - MFD - Renewal - 2022","OwnerId":"005D00000051tzbIAA","AccountId":"00120000002m9L2AAI","StageName":"Closed - Fallback","Id":"0063z000017gDdVAAU"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Amount\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":16926.63,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008sDNOIA2"},"Id":"005D0000008sDNOIA2","Name":"Aline Meloni"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSHNAA2"},"Id":"00120000002mSHNAA2","Name":"Nestle (Brazil)","Country__c":"Brazil","Report_Region__c":"LAR"},"Amount":12000.00,"CurrencyIsoCode":"USD","Report_Month__c":"2022-04-30","Product_Family__c":"Mintel Reports (LAR)","Type":"Upgrade","Name":"Nestle - Trends, BR Reports Food & Lifestyle","OwnerId":"005D0000008sDNOIA2","AccountId":"00120000002mSHNAA2","StageName":"Closed - Fallback","Id":"0063z000011orDMAAY"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":0,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008sDNOIA2"},"Id":"005D0000008sDNOIA2","Name":"Aline Meloni"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSHQAA2"},"Id":"00120000002mSHQAA2","Name":"Nestle (Chile)","Country__c":"Chile","Report_Region__c":"LAR"},"CurrencyIsoCode":"USD","Report_Month__c":"2022-04-30","Product_Family__c":"Mintel Reports (LAR)","Type":"Upgrade","Name":"Nestlé Chile - Global Consumer tool","OwnerId":"005D0000008sDNOIA2","AccountId":"00120000002mSHQAA2","StageName":"Closed - Fallback","Id":"0063z000015YfiLAAS"},{"ContainsKeys":"[\"Id\",\"StageName\",\"AccountId\",\"OwnerId\",\"Name\",\"Type\",\"Product_Family__c\",\"Report_Month__c\",\"CurrencyIsoCode\",\"Account\",\"Owner\",\"ExchangedCurrency\",\"Exchanged\"]","Exchanged":0,"ExchangedCurrency":"AUD","Owner":{"attributes":{"type":"User","url":"/services/data/v55.0/sobjects/User/005D0000008sDNOIA2"},"Id":"005D0000008sDNOIA2","Name":"Aline Meloni"},"Account":{"attributes":{"type":"Account","url":"/services/data/v55.0/sobjects/Account/00120000002mSHuAAM"},"Id":"00120000002mSHuAAM","Name":"Nestle (Mexico)","Country__c":"Mexico","Report_Region__c":"LAR"},"CurrencyIsoCode":"USD","Report_Month__c":"2022-04-30","Product_Family__c":"Mintel Reports (LAR)","Type":"Upgrade","Name":"Nestlé Mexico - Global Consumer tool","OwnerId":"005D0000008sDNOIA2","AccountId":"00120000002mSHuAAM","StageName":"Closed - Fallback","Id":"0063z000015YmGOAA0"}');

HTTPResponse res = http.send(req);
system.debug(res);
        while (res.getStatusCode() == 302) {
            req.setEndpoint(res.getHeader('Location'));
            res = new Http().send(req);
        }
        Blob body = res.getBodyAsBlob(); 
        
        Attachment attachmentCS = new Attachment();     
        
        attachmentCS.Name = 'ORDER FORM' + '--'+ System.now().format('ddMMyyyy')+'.xls';         
        attachmentCS.body = body;
        attachmentCS.ParentId = '0061j000006x8QwAAI';
        attachmentCS.isPrivate = false;
        
        insert attachmentCS; 
        system.debug(attachmentCS.Id);
    }
}